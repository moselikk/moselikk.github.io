<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <title>
    Nginx Conf
  </title>
  <meta
    name="description"
    content="Nginx 是一种高性能的 Web 服务器软件，也可以充当反向代理服务器、负载均衡器等。在使用 Nginx 时，经常会遇到需要根据请求的路径进行转发或者重定向的情况，本文将详细讲解如何配置 Nginx 根据路径转发的步骤。"
  />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link
    rel="canonical"
    href="https://moselikk.com/blog/nginx-conf"
  />
  <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
  <link rel="stylesheet" href="/css/main.css">
  <link rel="alternate" type="application/rss+xml" title="moselikk"
  href="https://moselikk.com/feed.xml">
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Nginx Conf | moselikk</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Nginx Conf" />
<meta name="author" content="Moselikk" />
<meta property="og:locale" content="zh_cmn_Hans" />
<meta name="description" content="Nginx 是一种高性能的 Web 服务器软件，也可以充当反向代理服务器、负载均衡器等。在使用 Nginx 时，经常会遇到需要根据请求的路径进行转发或者重定向的情况，本文将详细讲解如何配置 Nginx 根据路径转发的步骤。" />
<meta property="og:description" content="Nginx 是一种高性能的 Web 服务器软件，也可以充当反向代理服务器、负载均衡器等。在使用 Nginx 时，经常会遇到需要根据请求的路径进行转发或者重定向的情况，本文将详细讲解如何配置 Nginx 根据路径转发的步骤。" />
<link rel="canonical" href="https://moselikk.com/blog/nginx-conf" />
<meta property="og:url" content="https://moselikk.com/blog/nginx-conf" />
<meta property="og:site_name" content="moselikk" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-06-25T22:00:00+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Nginx Conf" />
<meta name="google-site-verification" content="" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Moselikk"},"dateModified":"2023-06-25T22:00:00+08:00","datePublished":"2023-06-25T22:00:00+08:00","description":"Nginx 是一种高性能的 Web 服务器软件，也可以充当反向代理服务器、负载均衡器等。在使用 Nginx 时，经常会遇到需要根据请求的路径进行转发或者重定向的情况，本文将详细讲解如何配置 Nginx 根据路径转发的步骤。","headline":"Nginx Conf","mainEntityOfPage":{"@type":"WebPage","@id":"https://moselikk.com/blog/nginx-conf"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://moselikk.com/apple-touch-icon.png"},"name":"Moselikk"},"url":"https://moselikk.com/blog/nginx-conf"}</script>
<!-- End Jekyll SEO tag -->

  <script>

  </script>
  <script>
  </script>
</head>

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-K329WMFD');</script>
  <!-- End Google Tag Manager -->
<body>
  <!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K329WMFD"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
  <div class="outer">
    <div class="page-content" id="article">
      <div class="wrapper">
        <div id="hitokoto" class="hitokoto">
          <a href="#" id="hitokoto_text">...... </a>
        </div>
        <div class="hanging-drop">
        </div>
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
      <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Nginx Conf</h1>
    <p class="post-meta">
      <span><svg width="10px" height="10px" style="fill: #888; margin-right: 5px; vertical-align: baseline;" viewBox="0 0 16 16"><path d="M2.06 6.69c.14-.4.5-.69.94-.69h11V5c0-.55-.45-1-1-1H6.41l-1.7-1.71A.997.997 0 0 0 4 2H1c-.55 0-1 .45-1 1v9.84l2.05-6.15h.01zM16 8c0-.55-.45-1-1-1H4a.99.99 0 0 0-.94.69l-2 6c-.04.09-.06.2-.06.31 0 .55.45 1 1 1h11c.44 0 .81-.29.94-.69l2-6c.04-.09.06-.2.06-.31z"></path></svg>
      <time datetime="2023-06-25T22:00:00+08:00" itemprop="datePublished">Jun 25, 2023</time></span>
      <a href="/"><span><svg width="10px" height="10px" style="fill: #888; margin-right: 5px; vertical-align: baseline;" viewBox="0 0 16 16"><path d="M1 3h14c.55 0 1-.45 1-1s-.45-1-1-1H1c-.55 0-1 .45-1 1s.45 1 1 1zm14 10H1c-.55 0-1 .45-1 1s.45 1 1 1h14c.55 0 1-.45 1-1s-.45-1-1-1zm0-4H1c-.55 0-1 .45-1 1s.45 1 1 1h14c.55 0 1-.45 1-1s-.45-1-1-1zm0-4H1c-.55 0-1 .45-1 1s.45 1 1 1h14c.55 0 1-.45 1-1s-.45-1-1-1z"></path></svg>Home</span></a>
      <a href="mailto:moselikk@gmail.com"><span><svg width="10px" height="10px" style="fill: #888; margin-right: 5px; vertical-align: baseline;" viewBox="0 0 16 16"><path d="M6 10c-1.1 0-2-.9-2-2V3H1c-.55 0-1 .45-1 1v8c0 .55.45 1 1 1v2a1.003 1.003 0 0 0 1.71.71L5.41 13H10c.55 0 1-.45 1-1v-1.17l-.83-.83H6zm9-10H6c-.55 0-1 .45-1 1v7c0 .55.45 1 1 1h4.59l2.71 2.71c.17.18.42.29.7.29.55 0 1-.45 1-1V9c.55 0 1-.45 1-1V1c0-.55-.45-1-1-1z"></path></svg>Email</span></a>
      <a href="https://github.com/moselikk"><span><svg width="10px" height="10px" style="fill: #888; margin-right: 5px; vertical-align: baseline;" viewBox="0 0 16 16"><path d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>Github</span></a>
      <a href="/excerpt"><span><svg width="10px" height="10px" style="fill: #888; margin-right: 5px; vertical-align: baseline;" viewBox="0 0 16 16"><path d="M11 11c-.28 0-.53.11-.71.29L9 12.59V8c0-.55-.45-1-1-1s-1 .45-1 1v4.59L5.71 11.3A.965.965 0 0 0 5 11a1.003 1.003 0 0 0-.71 1.71l3 3c.18.18.43.29.71.29s.53-.11.71-.29l3-3A1.003 1.003 0 0 0 11 11zm1-7c-.03 0-.07 0-.1.01A5 5 0 0 0 2 5c0 .11.01.22.02.33A3.51 3.51 0 0 0 0 8.5c0 1.41.84 2.61 2.03 3.17C2.2 10.17 3.46 9 5 9c.06 0 .13.02.19.02C5.07 8.7 5 8.36 5 8c0-1.66 1.34-3 3-3s3 1.34 3 3c0 .36-.07.7-.19 1.02.06 0 .13-.02.19-.02 1.48 0 2.7 1.07 2.95 2.47A3.964 3.964 0 0 0 16 8c0-2.21-1.79-4-4-4z"></path></svg>Excerpt</span></a>
      <a href="/about"><span><svg xmlns="http://www.w3.org/2000/svg" width="10px" height="10px" style="fill: #888; margin-right: 5px; vertical-align: baseline;" viewBox="0 0 16 16"><!-- Icon from Tabler Icons by Paweł Kuna - https://github.com/tabler/tabler-icons/blob/master/LICENSE --><path fill="currentColor" d="M18.333 2c1.96 0 3.56 1.537 3.662 3.472l.005.195v12.666c0 1.96-1.537 3.56-3.472 3.662l-.195.005H5.667a3.667 3.667 0 0 1-3.662-3.472L2 18.333V5.667c0-1.96 1.537-3.56 3.472-3.662L5.667 2zM6 15a1 1 0 0 0-1 1v2l.007.117A1 1 0 0 0 7 18v-2l-.007-.117A1 1 0 0 0 6 15m3-4a1 1 0 0 0-1 1v6l.007.117A1 1 0 0 0 10 18v-6l-.007-.117A1 1 0 0 0 9 11m3 2a1 1 0 0 0-1 1v4l.007.117A1 1 0 0 0 13 18v-4l-.007-.117A1 1 0 0 0 12 13"/></svg>About</span></a>
    </p>
  </header>


  

  <div class="post-content" itemprop="articleBody">
    <p>Nginx 是一种高性能的 Web 服务器软件，也可以充当反向代理服务器、负载均衡器等。在使用 Nginx 时，经常会遇到需要根据请求的路径进行转发或者重定向的情况，本文将详细讲解如何配置 Nginx 根据路径转发的步骤。</p>

<h3 id="1-配置-location-指令">1. 配置 location 指令</h3>
<p>在 Nginx 中，可以使用 location 指令来匹配请求的 URL，然后进行转发或重定向。下面是 location 指令的语法格式：</p>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">location [ = | ~ | ~* | ^~ ] URL {</span>
    <span class="s">. . .</span>
<span class="err">}</span>
</code></pre></div></div>
<p>其中：</p>

<ul>
  <li>= 表示精确匹配 URL；</li>
  <li>~ 表示区分大小写的正则表达式匹配 URL；</li>
  <li>~* 表示不区分大小写的正则表达式匹配 URL；</li>
  <li>^~ 表示普通字符匹配URL。
对于大部分情况，我们使用最简单的普通字符匹配即可。比如下面的配置：
    <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">location /api {</span>
  <span class="s">proxy_pass http://127.0.0.1:8000;</span>
<span class="err">}</span>
</code></pre></div>    </div>
    <p>这个配置表示，如果请求的 URL 以 /api 开头，Nginx 就会将请求转发到 http://127.0.0.1:8000 这个地址。注意，这里的 /api 应该是相对于 Nginx 根路径的相对路径，并不是绝对路径。</p>
  </li>
</ul>

<h3 id="2-配置rewrite指令">2. 配置rewrite指令</h3>
<p>如果我们想要对请求的 URL 进行重定向，可以使用 rewrite 指令。比如下面的配置：</p>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">location /old {</span>
    <span class="s">rewrite ^/old(.*)$ /new$1 permanent;</span>
<span class="err">}</span>
</code></pre></div></div>
<p>这个配置表示，如果请求的 URL 以 /old 开头，Nginx 就会将URL中的 /old 替换成 /new 并进行重定向。注意，这里的重定向是永久重定向（301），如果需要临时重定向（302），可以将 permanent 改为 redirect。</p>

<p>示例一：转发 API 请求
假设我们有一个 Web 应用，需要将所有 API 请求转发到后台的 API 服务器，API 服务器的地址是 http://api.example.com，我们可以在 Nginx 中加入下面的配置：</p>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">location /api {</span>
    <span class="s">proxy_pass http://api.example.com;</span>
<span class="err">}</span>
</code></pre></div></div>
<p>这个配置表示，如果请求的 URL 以 /api 开头，Nginx 就会将请求转发到 http://api.example.com 这个地址。比如说，如果有一个请求 /api/users/1，Nginx 就会将请求转发到 http://api.example.com/api/users/1 这个地址，然后将 API 服务器返回的响应返回给客户端。</p>

<p>示例二：多站点部署
假设我们有两个 Web 应用，分别是前端应用和后台管理应用，前端应用的地址是 http://example.com，后台管理应用的地址是 http://admin.example.com，我们可以在 Nginx 中加入下面的配置：</p>

<h3 id="前端应用配置">前端应用配置</h3>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">server {</span>
    <span class="s">server_name example.com;</span>
    <span class="s">location / {</span>
        <span class="s">root /var/www/example.com;</span>
        <span class="s">index index.html;</span>
    <span class="s">}</span>
<span class="err">}</span>
</code></pre></div></div>

<h3 id="后台管理应用配置">后台管理应用配置</h3>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">server {</span>
    <span class="s">server_name admin.example.com;</span>
    <span class="s">location / {</span>
        <span class="s">proxy_pass http://127.0.0.1:8000;</span>
    <span class="s">}</span>
<span class="err">}</span>
</code></pre></div></div>
<p>这个配置表示，如果请求的域名是 example.com，并且请求的 URL 不以 /api 开头，Nginx 就会将请求映射到 /var/www/example.com 目录下的静态文件，例如 /index.html；如果请求的域名是 admin.example.com，或者请求的 URL 以 /api 开头，Nginx 就会将请求转发到 http://127.0.0.1:8000 这个应用服务器，这个服务器可以是一个 Django 应用、Flask 应用、Node.js 应用等。</p>

<p>注意，这个配置中我们使用了不同的虚拟主机（server）来处理不同的域名，这样可以让不同的应用使用不同的配置。并且，我们在后台管理应用的 location 中加入了 /api 前缀的匹配，这是为了将 API 请求转发到后台的 API 服务器，和前端应用的静态文件请求区分开来。</p>


  </div>
<!-- Gitalk 评论系统 -->

<div id="gitalk-container"></div>
<script>
  const gitalk = new Gitalk({
    clientID: '',
    clientSecret: '',
    repo: 'moselikk/moselikk.github.io',
    owner: 'moselikk',
    admin: '["moselikk"]',
    id: 'https://moselikk.com/blog/nginx-conf', // Ensure uniqueness and length less than 50
    distractionFreeMode: 'false' // Facebook-like distraction free mode
  })
  gitalk.render('gitalk-container')
</script>

</article>

      </div>
    </div>
  </div>
  <script>
    // open outbound links in new tab
    let origin = document.location.origin;
    let links = document.getElementsByTagName("a");
    for (let link of links) {
      if (
        link.href &&
        link.href.indexOf(origin) != 0 &&
        !link.href.includes("mailto:")
      )
        link.setAttribute("target", "_blank");
    }

    // responsive table
    let tables = document.getElementsByTagName("table");
    for (let table of tables) {
      let ths = table.tHead.rows[0].cells;
      let trs = table.tBodies[0].rows;
      for (let row of trs) {
        for (let i = 0; i < row.cells.length; i++) {
          row.cells[i].setAttribute("data-label", ths[i].textContent);
        }
      }
    }

    // hitokoto api
    const rule = ["a", "b","c","d","h","i","j","k"];
    const query = rule.map(item => `c=${item}`).join('&');

      // Function to fetch hitokoto
      function fetchHitokoto() {
      fetch(`https://v1.hitokoto.cn?${query}`)
        .then((response) => response.json())
        .then((data) => {
          const hitokoto = document.getElementById("hitokoto_text");
          hitokoto.href = "https://hitokoto.cn/?uuid=" + data.uuid;
          const from = data.from ? " -" + data.from : ''
          hitokoto.innerText = data.hitokoto + from;
          // Store the timestamp and result of the last API call
          localStorage.setItem('lastHitokotoCall', Date.now());
          localStorage.setItem('lastHitokotoResult', JSON.stringify(data));
        })
        .catch(console.error);
    }

    // Function to use the last hitokoto result
    function useLastHitokotoResult() {
      const data = JSON.parse(localStorage.getItem('lastHitokotoResult'));
      const hitokoto = document.getElementById("hitokoto_text");
      hitokoto.href = "https://hitokoto.cn/?uuid=" + data.uuid;
      hitokoto.innerText = data.hitokoto;
    }

    // Check if we can call the API
    function canCallHitokoto() {
      const lastCall = localStorage.getItem('lastHitokotoCall');
      const now = Date.now();
      // Check if the last call was more than a minute ago
      return !lastCall || now - lastCall > 60 * 1000;
    }

    // Main logic
    if (canCallHitokoto()) {
      fetchHitokoto();
    } else {
      const lastResult = localStorage.getItem('lastHitokotoResult');
      if (lastResult) {
        useLastHitokotoResult();
      } else {
        fetchHitokoto();
      }
    }
  </script>
  <!-- <script src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token": ""}'
    onerror="gtag('set', 'user_properties', {blocker: 'true'});"></script> -->
  <script src="/js/zooming.min.js"></script>
  <script>
    if (window.Zooming && typeof screen.orientation == "undefined")
      window.addEventListener("load", function () {
        new Zooming().listen(".post-content img");
      });
  </script>
  <script src="../js/denglong.js"></script>
</body>

</html>